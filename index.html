<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­è³ è½‰äºç›¤ + é æ¸¬å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f4f8; color: #333; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 24px; }
        .input-group { margin: 16px 0; }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input { width: 100%; padding: 14px; font-size: 18px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 16px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 20px; }
        button:hover { background: #219653; }
        #result { margin-top: 24px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); white-space: pre-wrap; line-height: 1.6; }
    </style>
</head>
<body>
    <h1>æ­è³ è½‰äºç›¤ + é æ¸¬å·¥å…·</h1>

    <div class="input-group">
        <label>ä¸»å‹è³ ç‡</label>
        <input type="text" id="homeOdds" placeholder="ä¾‹: 1.80" maxlength="5">
    </div>

    <div class="input-group">
        <label>å’Œå±€è³ ç‡</label>
        <input type="text" id="drawOdds" placeholder="ä¾‹: 3.50" maxlength="5">
    </div>

    <div class="input-group">
        <label>å®¢å‹è³ ç‡</label>
        <input type="text" id="awayOdds" placeholder="ä¾‹: 4.00" maxlength="5">
    </div>

    <div class="input-group">
        <label>ç¸½æ°´ä½ï¼ˆé è¨­ 4.00ï¼‰</label>
        <input type="number" id="totalOdds" value="4.00" step="0.01">
    </div>

    <button onclick="calculate()">è¨ˆç®—</button>

    <div id="result"></div>

    <script>
        // è‡ªå‹•è·³è½‰ + æ¸…ç©ºè¼¸å…¥æ¡†
        const inputs = [document.getElementById('homeOdds'), document.getElementById('drawOdds'), document.getElementById('awayOdds')];
        inputs.forEach((input, index) => {
            // é»æ“Šè‡ªå‹•æ¸…ç©º
            input.addEventListener('focus', () => input.select());

            // è¼¸å…¥å®Œæˆè‡ªå‹•è·³ä¸‹ä¸€å€‹
            input.addEventListener('input', () => {
                if (input.value.length >= 4 && input.value.includes('.')) {
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                }
            });
        });

        // é»ç•«é¢å…¶ä»–åœ°æ–¹é—œé–‰éµç›¤
        document.addEventListener('touchstart', (e) => {
            if (!e.target.closest('input') && !e.target.closest('button')) {
                document.activeElement.blur();
            }
        });

        // Poisson ç›¸é—œå‡½æ•¸ï¼ˆèˆ‡ä½  Android ç‰ˆä¸€è‡´ï¼‰
        const MAX_GOALS = 7;

        function factorial(n) {
            if (n <= 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        function poissonOutcomeProbs(d, totalGoals, maxGoals = MAX_GOALS) {
            const lamH = Math.max((totalGoals + d) / 2, 1e-9);
            const lamA = Math.max((totalGoals - d) / 2, 1e-9);
            let win = 0, draw = 0, loss = 0;

            for (let i = 0; i <= maxGoals; i++) {
                const px = Math.exp(-lamH) * Math.pow(lamH, i) / factorial(i);
                for (let j = 0; j <= maxGoals; j++) {
                    const py = Math.exp(-lamA) * Math.pow(lamA, j) / factorial(j);
                    if (i > j) win += px * py;
                    else if (i === j) draw += px * py;
                    else loss += px * py;
                }
            }
            const s = win + draw + loss;
            return s > 0 ? [win / s, draw / s, loss / s] : [1/3, 1/3, 1/3];
        }

        function linspace(start, end, count) {
            if (count <= 1) return [start];
            const step = (end - start) / (count - 1);
            return Array.from({length: count}, (_, i) => start + i * step);
        }

        function fitPoissonParams(odds) {
            const inv = odds.map(o => 1 / o);
            const sumInv = inv.reduce((a, b) => a + b, 0);
            const target = inv.map(v => v / sumInv);

            let bestErr = Infinity, bestK = 0, bestTg = 0;

            linspace(0, 4, 81).forEach(k => {
                linspace(0.8, 4.5, 75).forEach(tg => {
                    const [w, dr, l] = poissonOutcomeProbs(k, tg);
                    const err = (w - target[0])**2 + (dr - target[1])**2 + (l - target[2])**2;
                    if (err < bestErr) { bestErr = err; bestK = k; bestTg = tg; }
                });
            });

            return { totalGoals: bestTg, rr: 1 / sumInv };
        }

        function findFavHandicap(odds) {
            const invSum = odds.reduce((a, o) => a + 1/o, 0);
            const pHome = (1/odds[0]) / invSum;
            const pAway = (1/odds[2]) / invSum;
            const pFav = pHome < pAway ? pHome : pAway;
            const sign = pHome < pAway ? 1 : -1;

            const fit = fitPoissonParams(odds);
            let g = Math.max(1.5, Math.min(4.0, fit.totalGoals)) - 0.15;
            const maxG = g > 3.5 ? 10 : MAX_GOALS;

            let low = -3.0, high = 3.0;
            for (let i = 0; i < 50; i++) {
                const mid = (low + high) / 2;
                const [w] = poissonOutcomeProbs(mid, g, maxG);
                if (w < pFav) low = mid;
                else high = mid;
            }

            return [sign * (low + high) / 2, g, fit.rr];
        }

        function roundToQuarter(value) {
            return Math.round(value * 4) / 4;
        }

        function selectThreeSlots(est, step = 0.25) {
            const center = roundToQuarter(est);
            return [center - step, center, center + step].sort((a,b) => Math.abs(a - est) - Math.abs(b - est));
        }

        function getHandicapLabel(disc) {
            const absD = Math.abs(disc);
            const rounded = roundToQuarter(absD);
            let label = {
                0.00: "å¹³æ‰‹",
                0.25: "å¹³æ‰‹/åŠçƒ",
                0.50: "åŠçƒ",
                0.75: "åŠçƒ/ä¸€çƒ",
                1.00: "ä¸€çƒ",
                1.25: "ä¸€çƒ/çƒåŠ",
                1.50: "çƒåŠ",
                1.75: "çƒåŠ/å…©çƒ",
                2.00: "å…©çƒ",
                2.25: "å…©çƒ/å…©çƒåŠ",
                2.50: "å…©çƒåŠ",
                2.75: "å…©çƒåŠ/ä¸‰çƒ",
                3.00: "ä¸‰çƒ",
                3.25: "ä¸‰çƒ/ä¸‰çƒåŠ",
                3.50: "ä¸‰çƒåŠ",
                3.75: "ä¸‰çƒåŠ/å››çƒ"
            }[rounded] || rounded.toFixed(2);

            return disc > 0 ? label + "ï¼ˆå—ï¼‰" : label + "ï¼ˆè®“ï¼‰";
        }

        function goalMapping(g) {
            const rounded = roundToQuarter(g);
            return {
                2.00: "2",
                2.25: "2/2.5",
                2.50: "2.5",
                2.75: "2.5/3",
                3.00: "3",
                3.25: "3/3.5",
                3.50: "3.5",
                3.75: "3.5/4"
            }[rounded] || rounded.toFixed(2);
        }

        function calcWaterRatio(cont, disc, totalOdds = 4.0) {
            let r = (cont - disc) / 0.25;
            r = Math.max(-1, Math.min(1, r));
            const delta = 0.08 * totalOdds * Math.tanh(r);
            const fav = Math.round((totalOdds / 2 - delta) * 1000) / 1000;
            const dog = Math.round((totalOdds - fav) * 1000) / 1000;
            return [fav, dog];
        }

        function calculate() {
            const home = parseFloat(document.getElementById('homeOdds').value) || NaN;
            const draw = parseFloat(document.getElementById('drawOdds').value) || NaN;
            const away = parseFloat(document.getElementById('awayOdds').value) || NaN;
            const totalOdds = parseFloat(document.getElementById('totalOdds').value) || 4.0;

            if (isNaN(home) || isNaN(draw) || isNaN(away)) {
                document.getElementById('result').innerText = "âŒ è«‹è¼¸å…¥å®Œæ•´ä¸‰å€‹è³ ç‡";
                return;
            }

            if ([home, draw, away].some(v => v <= 1.0)) {
                document.getElementById('result').innerText = "âŒ æ¯é …è³ ç‡éœ€ > 1.0";
                return;
            }

            const odds = [home, draw, away];
            const [est, g, rr] = findFavHandicap(odds);

            let output = `ğŸ“ˆ é æ¸¬è®“çƒï¼š${(-est).toFixed(3)}\n\n`;
            output += "ğŸ¯ è®“çƒç›¤æ°´ä½åˆ†é…ï¼š\n";
            selectThreeSlots(est).forEach(disc => {
                const displayDisc = -disc;
                const label = getHandicapLabel(displayDisc);
                const [fav, dog] = calcWaterRatio(est, disc, totalOdds);
                output += ` ${displayDisc.toFixed(2)} (${label}) â†’ ä¸» ${fav.toFixed(3)} / å®¢ ${dog.toFixed(3)}\n`;
            });

            output += `\nâš½ é æ¸¬ç¸½é€²çƒæ•¸ G â‰ˆ ${g.toFixed(3)}\n\n`;
            output += "ğŸ¯ å¤§å°ç›¤æ°´ä½åˆ†é…ï¼š\n";
            selectThreeSlots(g).forEach(gDisc => {
                const label = goalMapping(gDisc);
                const [big, small] = calcWaterRatio(g, gDisc, totalOdds);
                output += ` ${gDisc.toFixed(2)} (${label}) â†’ å¤§ ${big.toFixed(3)} / å° ${small.toFixed(3)}\n`;
            });

            document.getElementById('result').innerText = output;
        }
    </script>
</body>
</html>
