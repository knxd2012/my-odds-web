<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­è³ è½‰äºç›¤ + é æ¸¬å·¥å…·ï¼ˆç²¾æº–ç‰ˆï¼‰</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); color: #333; margin: 0; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 24px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .container { max-width: 620px; margin: 0 auto; }
        .input-group { margin: 18px 0; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        input, button { width: 100%; padding: 16px; font-size: 18px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; transition: all 0.3s; }
        input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        button { background: linear-gradient(to right, #27ae60, #2ecc71); color: white; border: none; cursor: pointer; margin-top: 24px; font-weight: bold; font-size: 19px; letter-spacing: 1px; }
        button:hover { background: linear-gradient(to right, #219653, #27ae60); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); }
        button:active { transform: translateY(0); }
        
        /* åˆ†çµ„æ¨£å¼ */
        .result-section { 
            margin-top: 30px; 
            padding: 25px; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.08); 
            white-space: pre-wrap; 
            line-height: 1.7; 
            font-size: 16px; 
            border-left: 5px solid #3498db;
        }
        
        .result-section:nth-child(even) {
            border-left-color: #e74c3c;
            background: #fefefe;
        }
        
        .history-section { 
            margin-top: 24px; 
            padding: 20px; 
            background: #fff; 
            border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            max-height: 500px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
            line-height: 1.6; 
            font-size: 15px; 
            display: none;
        }
        
        /* æ­·å²è¨˜éŒ„åˆ†éš”ç·š */
        .history-separator {
            margin: 15px 0;
            border: none;
            height: 1px;
            background: linear-gradient(to right, transparent, #3498db, transparent);
        }
        
        /* é«˜äº®æ¨£å¼ */
        .highlight-red { 
            color: #e74c3c; 
            font-weight: 600; 
            background: #fee; 
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .highlight-blue { 
            color: #3498db; 
            font-weight: 600; 
            background: #eef7ff; 
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .highlight-green { 
            color: #27ae60; 
            font-weight: 600; 
            background: #eaffea; 
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        /* æ¨™é¡Œæ¨£å¼ */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .section-title::before {
            content: "â–¶ ";
            color: #3498db;
        }
        
        /* åˆ‡æ›æŒ‰éˆ• */
        .toggle-container {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        
        .toggle-btn {
            flex: 1;
            margin: 0 5px;
            padding: 12px;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { max-width: 100%; }
            input, button { padding: 14px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš½ æ­è³ è½‰äºç›¤ + é æ¸¬å·¥å…·ï¼ˆç²¾æº–ç‰ˆï¼‰</h1>

        <div class="input-group">
            <label>ğŸ  ä¸»å‹è³ ç‡</label>
            <input type="text" id="homeOdds" placeholder="ä¾‹: 1.80" maxlength="8" value="1.80">
        </div>
        <div class="input-group">
            <label>ğŸ¤ å’Œå±€è³ ç‡</label>
            <input type="text" id="drawOdds" placeholder="ä¾‹: 3.50" maxlength="8" value="3.50">
        </div>
        <div class="input-group">
            <label>âœˆï¸ å®¢å‹è³ ç‡</label>
            <input type="text" id="awayOdds" placeholder="ä¾‹: 4.00" maxlength="8" value="3.50">
        </div>
        <div class="input-group">
            <label>ğŸ’° ç¸½æ°´ä½ï¼ˆé è¨­ 4.00ï¼‰</label>
            <input type="number" id="totalOdds" value="4.00" step="0.01" min="3.5" max="5">
        </div>

        <div class="toggle-container">
            <button class="toggle-btn active" onclick="showResult()">é¡¯ç¤ºçµæœ</button>
            <button class="toggle-btn" onclick="showHistory()">é¡¯ç¤ºæ­·å²</button>
        </div>

        <button onclick="calculate()">ğŸ“Š é–‹å§‹è¨ˆç®—</button>

        <div id="history" class="history-section"></div>
        <div id="result" class="result-section"></div>
    </div>

    <script>
        // è¼¸å…¥è¼”åŠ©
        const inputs = [document.getElementById('homeOdds'), document.getElementById('drawOdds'), document.getElementById('awayOdds')];
        inputs.forEach((input, idx) => {
            input.addEventListener('focus', () => input.select());
            input.addEventListener('input', () => {
                if (input.value.length >= 4 && input.value.includes('.')) {
                    if (idx < inputs.length - 1) inputs[idx + 1].focus();
                }
            });
        });
        document.addEventListener('touchstart', e => {
            if (!e.target.closest('input') && !e.target.closest('button')) document.activeElement.blur();
        });

        const MAX_GOALS = 10;
        const HOME_ADVANTAGE = -0.11;  // æ¸›å°ä¸»å ´å„ªå‹¢

        function factorial(n) {
            if (n <= 1) return 1;
            let res = 1;
            for (let i = 2; i <= n; i++) res *= i;
            return res;
        }

        function poissonProbs(d, totalGoals, maxGoals = MAX_GOALS) {
            const lamH = Math.max((totalGoals + d) / 2 + HOME_ADVANTAGE, 0.01);
            const lamA = Math.max((totalGoals - d) / 2, 0.01);
            let win = 0, draw = 0, loss = 0;
            for (let i = 0; i <= maxGoals; i++) {
                const ph = Math.exp(-lamH) * Math.pow(lamH, i) / factorial(i);
                for (let j = 0; j <= maxGoals; j++) {
                    const pa = Math.exp(-lamA) * Math.pow(lamA, j) / factorial(j);
                    const p = ph * pa;
                    if (i > j) win += p;
                    else if (i === j) draw += p;
                    else loss += p;
                }
            }
            const sum = win + draw + loss;
            return sum > 0 ? [win/sum, draw/sum, loss/sum] : [0.4, 0.3, 0.3];
        }

        function calcReturnRate(odds) {
            return 1 / (1/odds[0] + 1/odds[1] + 1/odds[2]);
        }

        function normalizeImpliedProbs(odds) {
            const inv = odds.map(x => 1/x);
            const sumInv = inv.reduce((a,b)=>a+b, 0);
            return inv.map(v => v / sumInv);
        }

        function fitPoissonParams(odds) {
            const target = normalizeImpliedProbs(odds);
            let bestErr = Infinity, bestD = 0, bestG = 2.5;

            // ç¬¬ä¸€éšæ®µï¼šç²—èª¿
            for (let d = -2; d <= 2; d += 0.1) {
                for (let g = 2.0; g <= 3.5; g += 0.1) {
                    const [w, dr, l] = poissonProbs(d, g);
                    const err = Math.pow(w - target[0], 2) + Math.pow(dr - target[1], 2) + Math.pow(l - target[2], 2);
                    if (err < bestErr) {
                        bestErr = err;
                        bestD = d;
                        bestG = g;
                    }
                }
            }

            // ç¬¬äºŒéšæ®µï¼šç´°èª¿
            for (let d = bestD - 0.1; d <= bestD + 0.1; d += 0.02) {
                for (let g = bestG - 0.2; g <= bestG + 0.2; g += 0.05) {
                    const [w, dr, l] = poissonProbs(d, g);
                    const err = Math.pow(w - target[0], 2) + Math.pow(dr - target[1], 2) + Math.pow(l - target[2], 2);
                    if (err < bestErr) {
                        bestErr = err;
                        bestD = d;
                        bestG = g;
                    }
                }
            }

            const rr = calcReturnRate(odds);
            const G = Math.max(2.0, Math.min(4.0, bestG));
            
            // å…¨å±€æ ¡æº–ï¼šæ¸›å°‘ç´„0.15
            const calibratedG = G - 0.15;
            
            return {d: bestD, g: calibratedG, rr: rr};
        }

        function findFavHandicap(odds) {
            const invSum = odds.reduce((s, o) => s + 1/o, 0);
            const pHome = (1/odds[0]) / invSum;
            const pAway = (1/odds[2]) / invSum;

            // åˆ¤æ–·ç†±é–€
            const isHomeFav = pHome > pAway;
            const pFav = isHomeFav ? pHome : pAway;
            
            const fit = fitPoissonParams(odds);
            let G = fit.g;
            
            // äºŒåˆ†æœå°‹åè§£handicap
            let low = -2.0, high = 2.0;
            for (let i = 0; i < 60; i++) {
                const mid = (low + high) / 2;
                const [w, _, __] = poissonProbs(mid, G);
                const favWinProb = isHomeFav ? w : (1 - w - poissonProbs(mid, G)[1]);
                
                if (favWinProb < pFav) {
                    if (isHomeFav) low = mid;
                    else high = mid;
                } else {
                    if (isHomeFav) high = mid;
                    else low = mid;
                }
            }
            
            let est = (low + high) / 2;
            if (!isHomeFav) est = -est;
            
            return [est, G, fit.rr];
        }

        function roundQuarter(x) { return Math.round(x * 4) / 4; }

        function selectThreeSlots(v) {
            const c = roundQuarter(v);
            const slots = new Set();
            [c-0.25, c, c+0.25].sort((a,b) => Math.abs(a-v) - Math.abs(b-v)).forEach(s => slots.add(s));
            return Array.from(slots).slice(0, 3);
        }

        function handicapLabel(h) {
            const abs = Math.abs(h);
            const r = roundQuarter(abs);
            const map = {
                0:"å¹³æ‰‹", 0.25:"å¹³æ‰‹/åŠçƒ", 0.5:"åŠçƒ", 0.75:"åŠçƒ/ä¸€çƒ",
                1:"ä¸€çƒ", 1.25:"ä¸€çƒ/çƒåŠ", 1.5:"çƒåŠ", 1.75:"çƒåŠ/å…©çƒ",
                2:"å…©çƒ", 2.25:"å…©çƒ/å…©çƒåŠ", 2.5:"å…©çƒåŠ", 2.75:"å…©çƒåŠ/ä¸‰çƒ",
                3:"ä¸‰çƒ", 3.25:"ä¸‰çƒ/ä¸‰çƒåŠ", 3.5:"ä¸‰çƒåŠ", 3.75:"ä¸‰çƒåŠ/å››çƒ",
                4:"å››çƒ", 4.25:"å››çƒ/å››çƒåŠ", 4.5:"å››çƒåŠ"
            };
            const text = map[r] || r.toFixed(2);
            return h >= 0 ? text + "ï¼ˆä¸»è®“ï¼‰" : text + "ï¼ˆå®¢è®“ï¼‰";
        }

        function goalLabel(g) {
            const r = roundQuarter(g);
            const map = {2:"2", 2.25:"2/2.5", 2.5:"2.5", 2.75:"2.5/3", 3:"3", 3.25:"3/3.5", 3.5:"3.5", 3.75:"3.5/4", 4:"4"};
            return map[r] || r.toFixed(2);
        }

        function calcWaterRatio(center, disc, total = 4.0) {
            const unit = 0.25;
            const cap = 0.08;
            let r = (center - disc) / unit;
            r = Math.max(-1, Math.min(1, r));
            const delta = cap * total * Math.tanh(r);
            const fav = Math.round((total/2 - delta) * 1000) / 1000;
            const dog = Math.round((total - fav) * 1000) / 1000;
            return [fav, dog];
        }

        function highlightText(text, type) {
            const types = {
                'red': 'highlight-red',
                'blue': 'highlight-blue',
                'green': 'highlight-green'
            };
            return `<span class="${types[type] || 'highlight-blue'}">${text}</span>`;
        }

        function calculate() {
            const h = parseFloat(document.getElementById('homeOdds').value) || NaN;
            const d = parseFloat(document.getElementById('drawOdds').value) || NaN;
            const a = parseFloat(document.getElementById('awayOdds').value) || NaN;
            const total = parseFloat(document.getElementById('totalOdds').value) || 4.0;

            if (isNaN(h) || isNaN(d) || isNaN(a)) {
                document.getElementById('result').innerText = "âŒ è«‹è¼¸å…¥å®Œæ•´ä¸‰é …è³ ç‡";
                return;
            }
            if ([h,d,a].some(x => x <= 1.01)) {
                document.getElementById('result').innerText = "âŒ è³ ç‡å¿…é ˆ > 1.01";
                return;
            }

            const odds = [h, d, a];
            const [est, g, rr] = findFavHandicap(odds);

            // æ ¼å¼åŒ–è¼¸å‡º
            let out = '';
            out += `ğŸ¯ ${highlightText('è®“çƒç›¤åˆ†æ', 'blue')}\n`;
            out += `é æ¸¬è®“çƒï¼ˆä¸»è®“å®¢ï¼‰ï¼š${highlightText(est.toFixed(3), 'red')}\n`;
            out += `è¿”é‚„ç‡ â‰ˆ ${highlightText((rr*100).toFixed(2) + '%', 'green')}\n\n`;

            out += `${highlightText('è®“çƒç›¤åƒè€ƒæ°´ä½ï¼ˆä¸‰æª”ï¼‰:', 'blue')}\n`;
            selectThreeSlots(est).forEach(disc => {
                const label = handicapLabel(disc);
                const [up, lo] = calcWaterRatio(est, disc, total);
                const teamUp = est >= 0 ? "ä¸»" : "å®¢";
                const teamLo = est >= 0 ? "å®¢" : "ä¸»";
                out += `${disc >= 0 ? '+' : ''}${disc.toFixed(2)} (${label}) â†’ ${highlightText(teamUp + ' ' + up.toFixed(3), 'red')} / ${teamLo} ${lo.toFixed(3)}\n`;
            });

            const expH = (g + est)/2 + HOME_ADVANTAGE;
            const expA = (g - est)/2;
            out += `\nâš½ ${highlightText('é æœŸé€²çƒï¼š', 'blue')}ä¸»éšŠ â‰ˆ ${expH.toFixed(2)}ã€€å®¢éšŠ â‰ˆ ${expA.toFixed(2)}\n\n`;

            out += `${highlightText('å¤§å°ç›¤åˆ†æ', 'blue')}\n`;
            out += `é æ¸¬ç¸½é€²çƒæ•¸ G â‰ˆ ${highlightText(g.toFixed(3), 'green')}\n\n`;
            out += `${highlightText('å¤§å°ç›¤åƒè€ƒæ°´ä½ï¼ˆä¸‰æª”ï¼‰:', 'blue')}\n`;
            selectThreeSlots(g).forEach(gc => {
                const label = goalLabel(gc);
                const [big, small] = calcWaterRatio(g, gc, total);
                out += `${gc.toFixed(2)} (${label}) â†’ å¤§ ${big.toFixed(3)} / å° ${small.toFixed(3)}\n`;
            });

            // æ­·å²ç´€éŒ„
            const hist = document.getElementById('history');
            const ts = new Date().toLocaleString('zh-HK', {hour12: false});
            const separator = '<hr class="history-separator">';
            
            // ç”¨HTMLæ ¼å¼å­˜å„²æ­·å²
            const historyEntry = `
                <div class="result-section" style="margin-bottom: 15px;">
                    <div class="section-title">${ts}</div>
                    ${out.replace(/\n/g, '<br>')}
                </div>
                ${separator}
            `;
            
            hist.innerHTML = historyEntry + hist.innerHTML;
            hist.style.display = 'block';

            // é¡¯ç¤ºçµæœï¼ˆä½¿ç”¨HTMLæ ¼å¼ï¼‰
            document.getElementById('result').innerHTML = out.replace(/\n/g, '<br>');
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            showResult();
        }

        function showResult() {
            document.getElementById('result').style.display = 'block';
            document.getElementById('history').style.display = 'none';
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                if (btn.textContent.includes('çµæœ')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function showHistory() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('history').style.display = 'block';
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                if (btn.textContent.includes('æ­·å²')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // é é¢åŠ è¼‰æ™‚è‡ªå‹•è¨ˆç®—
        window.onload = function() {
            // é å…ˆå¡«å…¥ç¤ºä¾‹è³ ç‡
            document.getElementById('homeOdds').value = '1.80';
            document.getElementById('drawOdds').value = '3.50';
            document.getElementById('awayOdds').value = '3.50';
            
            // è‡ªå‹•è¨ˆç®—
            setTimeout(() => calculate(), 300);
        };
    </script>
</body>
</html>
